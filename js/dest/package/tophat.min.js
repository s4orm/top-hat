var dirMixin={methods:{dirClear:function(e){var e=e||this.fullpath,t=!1;return e=e.toString(),-1!=e.search(/\<script/i)&&(t=!0),-1!=e.search(/^\s{5}/i)&&(t=!0),t&&confirm("suspected in js attack dir:"+e)&&(param.exec&&param.exec.pid&&process.kill(param.exec.pid+1),win.close(!0)),e},createDir:function(){zz.window.file({title:lang.dir.new,des:lang.dir.name},function(e){var t,e=e||"newDir",i=param.tree.cachePaths[this.treeParam.idEnd];t=path.join(i,e);try{fs.mkdirSync(t),zz.q("#"+this.treeParam.idEnd+' [data-act="clickReloadDir"]').click()}catch(e){try{t=path.join(i,(new Date).toString()),fs.mkdirSync(t)}catch(e){if("EEXIST"!==e.code)throw e}}}.bind(this))},dirLoad:function(e){this.setFocus(this.focus);var t=e||__startDir;this.$set(this,"fullpath",t),this.dirFullpathArr(t),param.startApp&&this.treeInit(),this.thumbLoad(t),Vue.nextTick(function(){if(this.loading.thumb.elDOM=zz.q("#thumb"),__startPath&&"zip"==zz.getExtFromPath(__startPath)){var e=param.getIdByPath(__startPath),t=zz.q("#"+e+' [data-act="clickDirName"]');t&&t.click()}}.bind(this))},moveFilesToRootZipDir:function(e){if(e){var t=crypto.createHash("sha256"),i=(new Date).getTime()+e,s=t.update(i).digest("hex").substring(0,20);path.join(os.tmpdir(),param.programName+"."+s)}},makeTmpDir:function(e){if(e){var t=crypto.createHash("sha256"),i=(new Date).getTime()+e,s=t.update(i).digest("hex").substring(0,20),r=path.join(os.tmpdir(),param.programName+"."+s);return param.tmpDirs[e]=r,fs.existsSync(r)||fs.mkdirSync(r),r}},clickDirFullpathSelect:function(e){"select"==e.target.getAttribute("data-act")&&(this.flag.show.dirFullpath?this.$set(this.flag.show,"dirFullpath",!1):this.$set(this.flag.show,"dirFullpath",!0),Vue.nextTick(function(){var e=zz.q("#fullpath");e&&(e.focus(),e.setSelectionRange(0,e.value.length))}.bind(this)))},dirFullpathArr:function(e){for(var t,i,s=e.split(path.sep),r=[],a=1;a<s.length;a++)t=s[a],i=s.slice(0,a+1).join(path.sep),r.push({name:t,path:i});this.$set(this,"fullpathArr",r)},dirRename:function(e,t){if(!e)return!1;var i=param.getIdByPath(e);if(i){var s=zz.q("#"+i+' [data-id="'+i+'"]').innerHTML;zz.window.file({title:lang.rename,des:s,filename:s},function(s){if(s&&""!=s.replace(/^\s+|\s+$/gim)){var r=e.replace(/[^\/]+$/,s);fs.rename(e,r,function(){param.tree.cachePaths[i]=r;var e=this.treeBranchById(i);this.$set(e,"name",s),this.selectDir(r),this.setFocus("dir"),t&&t()}.bind(this))}}.bind(this))}},selectDir:function(e){var t=e||__startDir;this.$set(this,"fullpath",t),this.dirFullpathArr(t),this.pathHistory.push(t),this.thumbLoad(t)},tmpHaveDir:function(e){if(!e)return!1;var t=e.split("/"),i=!1;if(t.length<3)return!1;var s=path.join("/",t[1],t[2]),r=param.tmpDirs;for(var a in r)if(s==r[a]){i=!0;break}return i},deleteDirRecursive:function(e){fs.existsSync(e)&&(fs.readdirSync(e).forEach(function(t,i){var s=path.join(e,t);fs.lstatSync(s).isDirectory()?this.deleteDirRecursive(s):fs.unlinkSync(s)}.bind(this)),fs.rmdirSync(e))},getDirChildren:function(e,t){var i=[];fs.readdir(e,function(s,r){s||(r.forEach(function(t,s){var r=path.join(e,t);fs.lstatSync(r).isDirectory()&&i.push(r)}),t(i))})},loadDirFromFullpath:function(e,t){this.setFocus(this.focus),this.$set(this,"fullpath",e),this.dirFullpathArr(e),this.pathHistory.push(e),this.treeInit(),this.thumbLoad(e),t&&t()},clickDirTab:function(e){var t=e.target,i=t.getAttribute("data-act");if(i)switch(i){case"bookmarks":this.$set(this,"treeTabSelected","bookmarks");break;case"tree":this.$set(this,"treeTabSelected","tree")}},isTreeTab:function(e){return e==this.treeTabSelected},dirEnterFullpath:function(e){var t=e.target.value;t=path.normalize(t),t=t.replace(/[\/\\]+$/i,""),this.$set(this,"fullpath",t),this.treeJumpToDir(t),Vue.nextTick(function(){this.$set(this.flag.show,"dirFullpath",!1)}.bind(this))}}},fileMixin={methods:{createFile:function(e,t){var i,e=e||"key",t=t||"txt";if("name"==e)var e=e+(new Date).getTime();e=e+"."+t;var s=this.treeParam.idEnd,r=param.tree.cachePaths[s];i=path.join(r,e),fs.closeSync(fs.openSync(i,"w")),this.thumbLoad(this.fullpath)},clickCreateFile:function(e){zz.window.file({title:lang.file.new,filename:"name"},function(e){this.createFile(e)}.bind(this))},saveFile:function(){var e=this.thumbGetShowed(),t=e.path,i=e.name,s="",r="";switch(e.type){case"text":s=lang.file.confirm.save,r=lang.file.confirm.save+" "+i,zz.window.confirm({title:s,des:r},function(){var e=zz.q("#sceneText").value;fs.writeFile(t,e,function(e){if(e)throw e;this.console(lang.file.saved)}.bind(this))}.bind(this))}},copyFile:function(e,t,i){function s(e){r||(i(e),r=!0)}var r=!1,a=fs.createReadStream(e);a.on("error",function(e){s(e)});var h=fs.createWriteStream(t);h.on("error",function(e){s(e)}),h.on("close",function(e){s()}),a.pipe(h)},ls:function(e,t,i){var s,r=[],a=process.cwd(),h=["jpg","jpeg","gif","png","svg"],n=["mp4","avi","ogg","mkv","divx","wmv","flv"],o=["txt","key","js","json","htm","html","php","xml"],c=["ai","eps","pdf","psd"],l=0;i&&(a=i),s=fs.lstatSync(a),s.isDirectory()&&fs.readdir(a,function(t,i){function s(e,t){return new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare(e.name,t.name)}if(t)return void console.log(t,"fileMixin ls readdir err");i.forEach(function(e){var t=fs.lstatSync(a+"/"+e);if(t.isFile()){var i=e.match(/[^.]+$/)[0].toLowerCase(),s=i;-1!=h.indexOf(i)&&(s="img"),-1!=n.indexOf(i)&&(s="video"),-1!=o.indexOf(i)&&(s="text"),-1!=c.indexOf(i)&&(s="adobe");var d=e;d.length>24&&(d=d.replace(/\.[^.]+$/,"").substring(0,24)+"..."+i),r.push({id:l++,title:d,name:e,datetime:t.birthtime,datetimeMs:t.birthtimeMs,src:"file://"+a+"/"+e,dir:a,path:a+"/"+e,ext:i,type:s})}}),r.sort(s),l=0,r.map(function(e){e.id=l++}),e(r)})},fileGetListByDir:function(e,t){this.loadingStart();var i=function(e,t){var s=[];fs.readdir(e,function(r,a){if(r)return t(r);var h=0;!function r(){var n=a[h++];if(!n)return t(null,s);n=path.join(e,n),fs.stat(n,function(e,t){t&&t.isDirectory()?i(n,function(e,t){s=s.concat(t),r()}):(s.push(n),r())})}()})};i(e,function(e,i){if(e)throw e;this.loadingEnd(),t(i)}.bind(this))}}},deleteMixin={methods:{clickDelete:function(){this.delete()},delete:function(e){var t,i=this.thumb.selected,e=e||"thumb",s="";switch(e){case"thumb":i.length<1&&this.thumbSelectByIdMode(this.thumb.showed),s=lang.delete,t=lang.confirm.delete+i.length+lang.confirm.deleteEnd;var r=this.focus;this.setFocus("no"),zz.window.confirm({title:s,des:t},function(){this.setFocus(r),this.$root.loadingStart();var e=!1,t=this.thumb.selected,i=t.length,s=0;t.forEach(function(t){var r=this.getThumbById(t);"zip"==r.ext&&(e=!0),fs.unlink(r.path,function(){this.deleteThumbById(t),++s>=i&&(this.thumbCache(),this.deleteThumbEnd(s,e))}.bind(this))}.bind(this))}.bind(this));break;case"dir":var a=this.treeParam.idEnd,h=param.tree.cachePaths[a];s=lang.confirm.deleteFolder,t=lang.confirm.deleteFolder+h,zz.window.confirm({title:s,des:t},function(){var e=fs.lstatSync(h);e.isFile()&&fs.unlinkSync(h),e.isDirectory()&&(this.deleteDirRecursive(h),this.treeRemoveBranch(a));var t=!1,i=this.treeParentBranchByIdChild(a);i.parent&&(t=i.parent.id,zz.q("#"+t+' [data-act="clickReloadDir"]').click()),this.console(h+lang.confirm.wasDeleted)}.bind(this))}},deleteThumbEnd:function(e,t){var e=e||0;zz.window.alert({title:lang.deleteEnd,des:lang.deleted+e,timer:1200});var i=param.getPathById(this.treeParam.idEnd),s=i.split(path.sep);for(var r in param.tmpDirs)-1!=param.tmpDirs[r].search(s[2])&&(this.zipChanged[r]=!0);this.zipChanged[i]=!0,t&&zz.q("#"+this.treeParam.idEnd+' [data-act="clickReloadDir"]').click(),this.$root.loadingEnd(),this.console(e+" files deleted! "+(new Date).toString());var a=this.thumbGetFirstIdInFrame("home"),h=this.thumb.cache.dir[a];this.thumbFrameSet(a),this.$set(this.thumb,"showed",h.id),this.sceneSet(h),this.console(h.name),this.size(h),this.$set(this.thumb,"selected",[]),this.$set(this.loading.thumb,"loaded",this.thumb.dir.length)},deleteThumbById:function(e){for(var t,i=this.thumb.dir,s=-1,r=0;r<i.length;r++)if(t=i[r],e==t.id){s=r;break}s>-1&&this.thumb.dir.splice(s,1)}}},keyMixin={methods:{keyCommandsSetCache:function(){var e,t,i,s,r=param.keyCommands;for(i=0;i<r.length;i++)if(e=r[i],e.focus)for(s=0;s<e.focus.length;s++)t=e.focus[s],param.keyCommandsCache[t]||(param.keyCommandsCache[t]={}),param.keyCommandsCache[t][e.keyStr]=e.name;else param.keyCommandsCache.all[e.keyStr]=e.name},keyDown:function(e){var t,i=this.keyToStr(e),s=this.focus;if(""!=i&&(!param.keyCommandsCache[s]||(t=param.keyCommandsCache[s][i])||(s="all",param.keyCommandsCache[s][i]&&(t=param.keyCommandsCache[s][i]),t))&&t){if("thumb"==s)switch(t){case"zip":this.zipFiles();break;case"thumbMarkSet":this.thumbMarkSet();break;case"thumbMarkJumpTo":this.thumbMarkJumpTo();break;case"thumbSelectAll":this.thumbSelectAll();break;case"thumbUnselectAll":this.thumbUnselectAll();break;case"thumbNextRow":"video"!=this.scene.type&&(this.thumbGoShow("nextRow"),this.thumbScrollMoveByKey());break;case"thumbPrevRow":"video"!=this.scene.type&&(this.thumbGoShow("prevRow"),this.thumbScrollMoveByKey());break;case"thumbNextShow":this.thumbGoShow("next"),this.thumbScrollMoveByKey();break;case"thumbPrevShow":this.thumbGoShow("prev"),this.thumbScrollMoveByKey();break;case"endShow":"video"!=this.scene.type&&(this.thumbGoShow("end"),this.thumbScrollMoveByKey());break;case"homeShow":"video"!=this.scene.type&&(this.thumbGoShow("home"),this.thumbScrollMoveByKey());break;case"nextSelect":this.thumbSelectByIdMode(this.thumb.showed),this.thumbGoShow("next"),this.thumbScrollMoveByKey();break;case"prevSelect":this.thumbSelectByIdMode(this.thumb.showed),this.thumbGoShow("prev"),this.thumbScrollMoveByKey();break;case"prevRowSelect":"video"!=this.scene.type&&(this.thumbGoShow("prevRow"),this.thumbSelectByIdMode(this.thumb.showed,"prevRow"),this.thumbScrollMoveByKey());break;case"nextRowSelect":"video"!=this.scene.type&&(this.thumbSelectByIdMode(this.thumb.showed,"nextRow"),this.thumbGoShow("nextRow"),this.thumbScrollMoveByKey());break;case"delete":this.delete();break;case"nextDir":zz.q("#block-tree").blur(),this.treeDirGo("next");break;case"prevDir":zz.q("#block-tree").blur(),this.treeDirGo("prev");break;case"thumbImgFullscreen":!1===this.fullscreen?(gui.Window.get().enterFullscreen(),this.$set(this,"fullscreen",!0)):(gui.Window.get().leaveFullscreen(),this.$set(this,"fullscreen",!1));break;case"repackArch":var r=zz.q("#"+this.treeParam.idEnd+' [data-act="repack"]');r&&r.click()}if("dir"==s)switch(t){case"dirRename":this.dirRename(this.fullpath);break;case"zip":this.zipFolderById();break;case"deleteDir":this.delete("dir")}if("scene"==s)switch(this.scene.type){case"video":switch(t){case"videoNextSec":this.videoNextSec(3);break;case"videoPrevSec":this.videoPrevSec(3);break;case"videoNextSec10":this.videoNextSec(10);break;case"videoPrevSec10":this.videoPrevSec(10);break;case"videoNextSec30":case"videoNextSec30arrowTop":this.videoNextSec(30);break;case"videoPrevSec30":this.videoPrevSec(30);break;case"videoStartPause":case"videoStartPause2":this.videoStartPause();break;case"videoFullscreen":this.videoFullscreen();break;case"videoExitFullscreen":this.videoExitFullscreen()}break;case"txt":switch(t){case"textSelect":var a=zz.q("#sceneText");a.setSelectionRange(0,a.value.length);break;case"saveFile":this.saveFile()}break;case"img":switch(t){case"sceneImgZoomPlus":this.sceneImgZoom("plus");break;case"sceneImgZoomMinus":this.sceneImgZoom("minus");break;case"sceneMove":this.sceneMove("left");break;case"sceneMoveRight":this.sceneMove("right");break;case"sceneMoveTop":this.sceneMove("top");break;case"sceneMoveBottom":this.sceneMove("bottom")}}if("all"==s)switch(t){case"closeProgramm":this.closeProgramm();break;case"fullscreenWindow":!1===this.fullscreen?(gui.Window.get().enterFullscreen(),this.$set(this,"fullscreen",!0)):(gui.Window.get().leaveFullscreen(),this.$set(this,"fullscreen",!1))}}},keyToStr:function(e){var t=e.keyCode,i=[];return e.ctrlKey&&i.push("ctrl"),e.shiftKey&&i.push("shift"),e.altKey&&i.push("alt"),param.key[t]&&i.push(param.key[t]),i.join("+")}}},libMixin={methods:{size:function(e){fs.stat(e.path,function(e,t){var i=zz.sizeFormat(t.size),s=", size: "+i.sizeFormated+" "+i.format+" ";this.console(s,"append")}.bind(this))},getFileSize:function(e,t){if(!e)return!1;fs.stat(e,function(e,i){var s=zz.sizeFormat(i.size);t({sizeFormatted:s.sizeFormated+" "+s.format,sizeOriginal:i.size,format:s.format})}.bind(this))},getFileSizeSync:function(e){if(!e)return!1;var t=fs.statSync(e),i=zz.sizeFormat(t.size);return{sizeFormatted:i.sizeFormated+" "+i.format,sizeOriginal:t.size,format:i.format}},getSelectedId:function(){return this.treeParam.idEnd},getThumb:function(){return this.thumb.dir[this.thumb.showed]},getFileContent:function(e,t){t&&fs.readFile(e,function(e,i){if(e)throw e;t(i)})},console:function(e,t){var i=zz.q("#console"),s=document.createTextNode(e);t||(i.innerHTML=""),i.appendChild(s)},resizeWin:function(){var e=this.thumb.dir[this.thumb.showed];"img"==e.type&&this.sceneSet(e)},videoGet:function(){return zz.q("#sceneVideo")},sortByName:function(e,t){return new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare(e.name,t.name)},sortByDate:function(e,t){return new Date(e.datetimeMs).getTime()-new Date(t.datetimeMs).getTime()}}},sceneMixin={computed:{sceneThumbSelected:function(){var e=this.thumb.selected,t=this.thumb.showed;return e.indexOf(t)>-1}},methods:{sceneRotate:function(e){var t=this.scene.imgDrawnWidth*this.scene.percentCurrent/this.scene.percentCurrent,i=this.scene.imgDrawnHeight*this.scene.percentCurrent/this.scene.percentCurrent,s=calculateAspectRatio(this.scene.imgDrawnWidth,this.scene.imgDrawnHeight,t,i),e=e||90,r={src:this.scene.src,width:s.w,height:s.h,rotate:e};sceneDraw(r,this.sceneParamNew)},sceneParamNew:function(e){this.scene.imgOriginalWidth=e.width,this.scene.imgOriginalHeight=e.height,this.scene.left=e.left,this.scene.top=e.top,this.scene.imgDrawnWidth=e.imgDrawnWidth,this.scene.imgDrawnHeight=e.imgDrawnHeight,this.scene.offset.left=0,this.scene.offset.top=0},sceneImgZoom:function(e){var e=e||"minus",t=10;"minus"==e&&(t=-10);var i=this.scene.imgDrawnWidth*(this.scene.percentCurrent+t)/this.scene.percentCurrent,s=this.scene.imgDrawnHeight*(this.scene.percentCurrent+t)/this.scene.percentCurrent,r=calculateAspectRatio(this.scene.imgDrawnWidth,this.scene.imgDrawnHeight,i,s),a={src:this.scene.src,width:r.w,height:r.h};sceneDraw(a,this.sceneParamNew)},sceneImgZoomOut:function(){},sceneSet:function(e){if(this.videoStreamClear(),e)switch(this.scene.val="",this.$set(this.scene,"type",e.type),this.$set(this.scene,"ext",e.ext),this.$set(this.scene.offset,"top",0),this.$set(this.scene.offset,"left",0),e.type){case"img":this.$set(this.scene,"src",e.src);var t=zz.q("#scene");t&&(this.$set(this.scene,"width",t.offsetWidth),this.$set(this.scene,"height",t.offsetHeight)),sceneLoad(e,{maxWidth:this.scene.width,maxHeight:this.scene.height,antiAliasing:this.scene.antiAliasing},this.setSizeImgToScene);break;case"video":this.videoParamReset(),this.$set(this.scene,"src",e.src);break;case"text":this.getFileContent(e.path,function(e){var t=e.toString();this.$set(this.scene,"type","txt"),this.$set(this.scene,"val",t)}.bind(this));break;case"adobe":this.$set(this.scene,"src",e.src);var t=zz.q("#scene");t&&(this.$set(this.scene,"width",t.offsetWidth),this.$set(this.scene,"height",t.offsetHeight)),sceneLoad(e,{maxWidth:this.scene.width,maxHeight:this.scene.height,imgData:this.imgCachePreview[e.id]},this.setSizeImgToScene);break;default:this.$set(this.scene,"type","none"),sceneLoad("clear")}},sceneMove:function(e){var e=e||"left",t={src:this.scene.src,width:this.scene.imgDrawnWidth,height:this.scene.imgDrawnHeight};switch(e){case"right":t.left=this.scene.left+40;break;case"left":t.left=this.scene.left-40;break;case"top":t.top=this.scene.top+40;break;case"bottom":t.top=this.scene.top-40}this.sceneMoveDraw(t)},sceneMoveDraw:function(e){var t,i,s=!1,r=!1;this.scene.imgDrawnWidth>this.scene.width&&(t=Math.sign(e.left),t<0?this.scene.imgDrawnWidth-Math.abs(e.left)<this.scene.width&&(e.left=(this.scene.imgDrawnWidth-this.scene.width)*t):e.left>0&&(e.left=0),s=!0),this.scene.imgDrawnHeight>this.scene.height&&(i=Math.sign(e.top),i<0?this.scene.imgDrawnHeight-Math.abs(e.top)<this.scene.height&&(e.top=(this.scene.imgDrawnHeight-this.scene.height)*i):e.top>0&&(e.top=0),r=!0),(s||r)&&sceneDraw(e,this.sceneParamNew)}}},topMixin={methods:{clickTopMenu:function(e){var t=e.target.getAttribute("data-type");if(this.clickFocus("top"),t)switch(t){case"clickZipFolders":zz.window.confirm({title:lang.confirm.zipChildrenFolders,des:"<b>"+lang.confirm.zipChildrenFolders+"</b><br>",el:[{type:"checkbox",name:"deleteFoldersAfterZip",title:lang.confirm.deleteFoldersAfterZip}]},function(e){var e=e||{},t={};if(e.el&&e.el.checkbox)for(var i in e.el.checkbox)t[i]=e.el.checkbox[i];this.clickZipFolders(t)}.bind(this));break;case"clickZipCutOne":this.thumb.selected.length>0?this.clickZipCutOne():zz.window.alert({title:lang.alert.selectFiles,timer:5e3,des:"<b>"+lang.alert.selectFiles+"</b>"},void 0);break;case"clickDelete":this.clickDelete();break;case"clickZip":this.clickZip();break;case"clickCreateFile":this.clickCreateFile();break;case"clickCreateDir":this.createDir();break;case"clickAntiAliasing":this.scene.antiAliasing?this.$set(this.scene,"antiAliasing",!1):this.$set(this.scene,"antiAliasing",!0);break;case"clickHistoryBack":var i,s=this.pathHistory,r=s.indexOf(this.fullpath),a=0;r>0&&(a=r-1),i=s[a],this.dirLoad(i);var h=param.getIdByPath(i);if(!h)return;zz.q("#"+h+' [data-act="clickDirName"]').click();break;case"clickHistoryForward":var n,s=this.pathHistory,r=s.indexOf(this.fullpath),o=0;if(-1!=r&&(o=r+1),!(n=s[o]))return;this.dirLoad(n);var h=param.getIdByPath(n);if(!h)return;zz.q("#"+h+' [data-act="clickDirName"]').click();break;case"clickRename":this.dirRename(this.fullpath,function(){this.console(this.fullpath+lang.confirm.wasDeleted)}.bind(this));break;case"clickRenameGroup":var c=[],l=this.thumb.selected;l.length>0?this.thumb.dir.forEach(function(e){-1!=l.indexOf(e.id)&&c.push(e.name)}):this.thumb.dir.forEach(function(e){c.push(e.name)});var d=this.focus;this.setFocus("no"),zz.window.renameGroup({list:c},function(e){this.setFocus(d);var t=e.length,i=0;e.forEach(function(e){for(var s,r,a,h=0;h<this.thumb.dir.length;h++)s=this.thumb.dir[h],e.oldName==s.name&&(r=s.path,a=path.join(s.dir,e.newName),fs.rename(r,a,function(){if(i+=1,this.console(lang.total+t+", "+lang.renamed+i),i==t)if(this.console(lang.renameFinish),-1!=param.tree.cachePaths[this.treeParam.idEnd].search(/\.zip$/i)){var e=param.tmpDirs[param.tree.cachePaths[this.treeParam.idEnd]];e&&this.thumbLoad(e)}else this.thumbLoad(this.fullpath)}.bind(this)))}.bind(this))}.bind(this));break;case"clickEpsStock":this.stockEps10(this.fullpath);break;case"clickEpsStockCreateDir":zz.window.file({title:lang.dir.new,des:lang.dir.name},this.stockCreateFolder);break;case"clickRotateCounter":this.sceneRotate(-90);break;case"clickRotate":this.sceneRotate();break;case"clickBookmarksShow":this.clickBookmarksShow()}}}},bookmarksMixin={methods:{bookmarksRead:function(){var e=path.join(os.homedir(),"."+param.programName),t=path.join(os.homedir(),"."+param.programName,param.bookmarksFileName);fs.existsSync(e)||fs.mkdirSync(e),fs.readFile(t,function(e,i){if(e)return void fs.closeSync(fs.openSync(t,"w"));if(""!=i.toString()){var s=JSON.parse(i.toString());s||(s=[]),this.$set(this.$root,"bookmarks",s)}}.bind(this))},bookmarksWrite:function(){var e=path.join(os.homedir(),"."+param.programName,param.bookmarksFileName),t=JSON.stringify(this.$root.bookmarks);fs.writeFile(e,t,function(e){if(e)throw e;this.console(lang.bookmarks.saved)}.bind(this))},clickBookmarkAdd:function(){var e=this.$root.fullpath,t=path.parse(e).base;zz.window.confirm({title:lang.bookmarks.add,des:lang.bookmarks.add},function(){this.bookmarks.push({name:t,fullpath:e}),this.bookmarksWrite()}.bind(this))},bookmarkDelete:function(e){e&&zz.window.confirm({title:lang.bookmarks.delete,des:lang.bookmarks.delete+": "+e},function(){for(var t=0;t<this.bookmarks.length;t++)if(e==this.bookmarks[t].fullpath){this.bookmarks.splice(t,1);break}this.bookmarksWrite()}.bind(this))},clickBookmarks:function(e){var t=e.target,i=t.getAttribute("data-fullpath"),s=t.getAttribute("data-act");if(s&&i)switch(s){case"goto":param.tree.cachePaths={},param.startApp=!0,this.$set(this,"tree",{}),this.$set(this,"fullpath",i),this.dirFullpathArr(i),Vue.nextTick(function(){this.treeInit(i)}.bind(this)),this.thumbLoad(i),this.pathHistory.push(i),this.$set(this,"treeTabSelected","tree"),Vue.nextTick(function(){this.treeScrollSelectedIntoView()}.bind(this));break;case"delete":this.bookmarkDelete(i)}},clickBookmarksShow:function(){}}},thumbMixin={methods:{isShowed:function(e){return e==this.thumb.showed},isThumbMarked:function(e){return!1!==this.thumb.mark&&e==this.thumb.mark},thumbJumpToIdFrameSet:function(e){var t,i,s,e=e||0,r=param.thumb.inRow,a=param.thumb.rows,h=this.thumb.dir,n=this.thumb.frame,o=[],c=r*a,l=0,d=!1;for(s=0;s<n.length;s++)if(e==n[s].id){d=!0;break}if(!0!==d){for(s=0;s<h.length&&e!=h[s].id;s++);for(t=Math.floor(s/r),i=0==t?0:t*r,s=i;s<h.length&&!(l>=c);s++)o.push(h[s]),l++;this.$set(this.thumb,"frame",o),Vue.nextTick(function(){o.forEach(function(e){thumbFromData(e.id,this.thumb.imgCache[e.id],function(){})}.bind(this))}.bind(this))}},thumbFrameSet:function(e){var t=null,e=e||0;if(!(t=this.thumbGetFrame(e)))return!1;this.$set(this.thumb,"frame",t),Vue.nextTick(function(){t.forEach(function(e){thumbFromData(e.id,this.thumb.imgCache[e.id],function(){})}.bind(this))}.bind(this))},thumbGetFrame:function(e){for(var e=e||0,t=Math.floor(param.thumb.inRow*param.thumb.rows),i=t,s=[],r=!1,a=0;a<this.thumb.dir.length;a++)if(e==this.thumb.dir[a].id)r=!0,s.push(this.thumb.dir[a]),i--;else if(r){if(!(i>0))break;s.push(this.thumb.dir[a]),i--}return s},computeFirstFrame:function(){for(var e,t=param.thumb.inRow,i=param.thumb.rows,s=this.thumb.dir,r=[],a=this.thumb.dir[0].id,h=t*i,n=0,o=0;o<s.length&&(e=s[o],a==e.id&&(n=1),n>0&&(r.push(e),n++),!(n>h));o++);return r},thumbGetFromStartIndex:function(e){var t,i,s=param.thumb.inRow,r=param.thumb.rows,a=this.thumb.dir,h=[],n=0,o=0,c=s*r,l=0,d=0,u=0;if(this.thumb.dir.length>c){if(e==this.thumb.dir[this.thumb.dir.length-1].id){for(var m=param.thumb.inRow,f=this.thumb.dir.length;f>m;f-=m);var p=f;for(l=s*(r-1)+p,f=this.thumb.dir.length-1;f>=0;f--){if(d>=l)return h;t=a[f],h.unshift(t),d+=1}}if(e==this.thumb.dir[0].id);else if(this.thumb.frame.length)if(n=this.thumb.frame[0].id,e>n)(i=this.thumb.frame[s])&&(e=i.id);else{for(f=this.thumb.dir.length-1;f>=0;f--){if(0==f){o=0;break}if(u>0&&(u<=s&&(u+=1),u>s)){o=this.thumb.dir[f].id;break}n==this.thumb.dir[f].id&&(u+=1)}e=o}}for(var f=0;f<a.length&&(t=a[f],e==t.id&&(d=1),d>0&&(h.push(t),d++),!(d>c));f++);return h},thumbInFrame:function(e){for(var t,i=!1,s=0;s<this.thumb.frame.length;s++)t=this.thumb.frame[s],e==t.id&&(i=!0);return i},thumbGetFirstIdInFrame:function(e){var t,i,s,r,a=this.thumb.cache.idRow,h=this.thumb.cache.rows,n=param.thumb.rows;switch(e){case"prev":t=a[this.thumb.frame[0].id],r=t-1,r<1&&(r=t),i=h[r];break;case"next":var o=param.thumb.rows*param.thumb.inRow;if(this.thumb.frame.length<o)return!1;if(s=this.thumb.frame.length-1,t=a[this.thumb.frame[s].id],r=t+1-n+1,!h[r])return!1;i=h[r];break;case"home":i=h[1];break;case"end":r=h.length-n,i=h[r]?h[r]:h[1]}return i[0]},thumbCache:function(){var e,t,i=this.thumb.dir,s=1,r=param.thumb.inRow,a=0;for(this.thumb.cache.dir={},this.thumb.cache.idRow={},this.thumb.cache.rows=[null],t=0;t<i.length;t++)a==r&&(a=0,s+=1),e=i[t],this.thumb.cache.idRow[e.id]=s,this.thumb.cache.dir[e.id]=e,this.thumb.cache.rows[s]||(this.thumb.cache.rows[s]=[]),this.thumb.cache.rows[s]&&this.thumb.cache.rows[s].push(e.id),a++},thumbLoad:function(e){this.sceneSet("clear"),this.$set(this.thumb,"selected",[]),this.$set(this.thumb,"frame",[]),this.$set(this.thumb,"mark",!1),this.ls(function(e){function t(){if(this.thumb.threadsLoadingDir.length>1)return e.length=0,void this.thumb.threadsLoadingDir.shift();if(i>=e.length)return this.thumb.threadsLoadingDir.length=0,void(0==this.thumb.showed&&this.sceneSet(this.thumb.dir[0]));var s=e[i];i++,thumb(s,this.thumb.width,this.thumb.height,function(e,i){this.counterThumbnail(),e&&(this.thumb.imgCache[s.id]=e,i&&(this.imgCachePreview[s.id]=i.imgData,s.width=i.width,s.height=i.height)),setTimeout(t.bind(this),0)}.bind(this))}this.thumb.threadsLoadingDir.push("threadMark-"+(new Date).getTime()),this.$set(this.thumb,"dir",e),this.thumbFrameSet(0),this.thumbScrollInit(),this.thumb.dir[0]&&(this.console(this.thumb.dir[0].name),this.size(this.thumb.dir[0])),this.$set(this.loading.thumb,"total",e.length),this.$set(this.loading.thumb,"loaded",0),this.$set(this.loading,"percent",0),this.thumb.dir.length&&this.thumbSelectById(this.thumb.dir[0].id),this.thumbCache();var i=0;setTimeout(t.bind(this),0),this.setFocus("thumb")}.bind(this),"images",e)},getThumbById:function(e){for(var t,i=this.thumb.dir,s=0;s<i.length;s++)if(t=i[s],e==t.id)return t},thumbGetShowed:function(){return this.getThumbById(this.thumb.showed)},thumbUnselectAll:function(){var e,t=this.thumb.dir;this.thumb.selected=[];for(var i=0;i<t.length;i++)e=t[i],e.selectMode&&this.$set(e,"selectMode",!1)},thumbSelectAll:function(){var e,t=this.thumb.dir;if(this.thumb.selected.length==this.thumb.dir.length)return void this.thumbUnselectAll();this.thumb.selected=[];for(var i=0;i<t.length;i++)e=t[i],this.thumb.selected.push(e.id),this.$set(e,"selectMode",!0)},getHeightOfColumn:function(e){var t=param.thumb.inRow,i=this.thumb.heightFullLength,s=e+1,r=Math.ceil(s/t);return Math.ceil(i*r)},thumbSelectById:function(e){for(var t,i,s=this.thumb.dir,r=0;r<s.length;r++)t=s[r],e==t.id?(i=t,this.$set(this.thumb,"showed",t.id),this.$set(t,"selected",!0)):this.$set(t,"selected",!1);return i},thumbSelectByIdMode:function(e,t){var i,s=this.thumb.dir,r=null,t=t||!1,a=1,h=param.thumb.inRow;o=0;for(var n=0;n<s.length&&(i=s[n],!(t&&(r=null,a>h)));n++)if(e==i.id){if(i.selectMode){var o=this.thumb.selected.indexOf(e);o>-1&&this.thumb.selected.splice(o,1),this.$set(i,"selectMode",!1)}else this.thumb.selected.push(i.id),this.$set(i,"selectMode",!0);t&&(r=s[n+1],r&&(e=r.id),a+=1)}},clickThumb:function(e){var t=e.target,i=zz.find.parentAttr(t,"data-id");if(i){this.thumbSelectById(i);var s=this.getThumbById(i);this.sceneSet(s),this.console(s.name),this.size(s)}},clickThumbSort:function(e){var t,i=e.target,s=i.getAttribute("data-act"),r=param.thumb.inRow,a=param.thumb.rows,h=this.thumb.dir,n=[],o=r*a,c=0;if(s){switch(s){case"name":"increase"==this.thumb.sort.name.to?(h.sort(this.sortByName).reverse(),this.$set(this.thumb.sort.name,"arrow",lang.arrow.up),this.thumb.sort.name.to="decrease"):(h.sort(this.sortByName),this.$set(this.thumb.sort.name,"arrow",lang.arrow.down),this.thumb.sort.name.to="increase"),this.$set(this.thumb.sort.date,"arrow",""),this.thumb.sort.date.to="decrease",this.$set(this.thumb,"dir",h);break;case"date":"increase"==this.thumb.sort.date.to?(h.sort(this.sortByDate).reverse(),this.$set(this.thumb.sort.date,"arrow",lang.arrow.up),this.thumb.sort.date.to="decrease"):(h.sort(this.sortByDate),this.$set(this.thumb.sort.date,"arrow",lang.arrow.down),this.thumb.sort.date.to="increase"),this.$set(this.thumb.sort.name,"arrow",""),this.thumb.sort.name.to="decrease",this.$set(this.thumb,"dir",h)}for(this.thumbCache(),t=0;t<h.length&&!(c>=o);t++)n.push(h[t]),c++;this.$set(this.thumb,"frame",n),Vue.nextTick(function(){n.forEach(function(e){thumbFromData(e.id,this.thumb.imgCache[e.id],function(){})}.bind(this))}.bind(this))}},thumbGetIndex:function(e,t){var i,s,t=t||"next",r=!1,a=!1,h=param.thumb.inRow;switch(t){case"next":for(i=0;i<this.thumb.dir.length;i++){if(!1!==r)return a=this.thumb.dir[i].id;e==this.thumb.dir[i].id&&(r=!0)}break;case"nextRow":for(s=1,i=0;i<this.thumb.dir.length;i++)if(!1===r)e==this.thumb.dir[i].id&&(r=!0,s+=1);else{if(s>h)return a=this.thumb.dir[i].id;s+=1}break;case"prevRow":for(s=1,i=this.thumb.dir.length-1;i>=0;i--)if(!1===r)e==this.thumb.dir[i].id&&(r=!0,s+=1);else{if(s>h)return a=this.thumb.dir[i].id;if(0==i)return a=this.thumb.dir[i].id;s+=1}break;case"prev":for(i=this.thumb.dir.length-1;i>=0;i--){if(!1!==r)return a=this.thumb.dir[i].id;e==this.thumb.dir[i].id&&(r=!0)}break;case"home":return a=this.thumb.dir[0].id;case"end":return this.thumb.dir.length<1?a=!1:void 0==(a=this.thumb.dir[this.thumb.dir.length-1].id)&&(a=!1),a}return a},counterThumbnail:function(){this.$set(this.loading.thumb,"loaded",this.loading.thumb.loaded+1);var e,t,i=0;e=this.loading.thumb.loaded,t=this.loading.thumb.total,i=Math.ceil(100*e/t),this.$set(this.loading,"percent",i),i>=100&&this.$set(this.loading,"percent",0)},thumbSelectBy:function(e,t){for(var i,s,r=this.thumb.dir,a=0;a<r.length;a++)i=r[a],t==i[e]?(s=i,this.$set(this.thumb,"showed",i.id),this.$set(i,"selected",!0)):this.$set(i,"selected",!1);return s},thumbAddFile:function(){}}},thumbScrollMixin={methods:{thumbScrollInit:function(){var e,t,i=param.thumb.rowHeight,s=this.$root.thumb.scroll.height,r=this.thumb.dir.length,a=param.thumb.rows,h=Math.floor(r/a),n=r%a,o=h;o<1&&(o=1),n>0&&(o+=1),e=o*i,t=Math.floor(i*i/e),t>s&&(s=t),this.thumb.rowsTotal=o,this.$root.$set(this.$root.thumb.scroll,"height",s),this.$root.$set(this.$root.thumb.scroll,"top",2)},thumbScrollMouseMove:function(e){var t=Math.floor(param.thumb.inRow*param.thumb.rows);if(!(this.thumb.dir.length<t)){var i=this.$root.thumb.scroll.top+e.top;if(!(i<this.$root.thumb.scroll.topInit||i+this.$root.thumb.scroll.height+this.$root.thumb.scroll.bottom>this.thumb.thumbnails.height)){this.$set(this.thumb.scroll,"top",i),this.$set(this.thumb.scroll,"active",!0);var s=this.thumb.scroll.heightScrollOffsetRow,r=Math.floor(i/s);r>this.thumb.rowsTotal&&(r=this.thumb.rowsTotal-1);var a=Math.floor(r*param.thumb.inRow),h=this.thumb.dir[a];if(h){for(var n=[],o=!1,c=t,l=0;l<this.thumb.dir.length;l++)if(h.id==this.thumb.dir[l].id)o=!0,n.push(this.thumb.dir[l]),c--;else if(o){if(!(c>0))break;n.push(this.thumb.dir[l]),c--}var d=n.length%param.thumb.inRow,u=t-param.thumb.inRow,m=u+d,c=m;if(n.length<m){n=[];for(var l=this.thumb.dir.length;c--;)n.unshift(this.thumb.dir[--l])}this.$set(this.thumb,"frame",n),Vue.nextTick(function(){n.forEach(function(e){thumbFromData(e.id,this.thumb.imgCache[e.id],function(){})}.bind(this))}.bind(this))}}}},thumbScrollMoveByKey:function(){var e=this.$root.thumb.scroll.height,t=Math.floor(param.thumb.inRow*param.thumb.rows),i=this.thumb.thumbnails.height;if(!(this.thumb.dir.length<t)){for(var s=Math.ceil(this.thumb.dir.length/param.thumb.inRow),r=this.thumb.frame[0].id,a=0,h=0;h<this.thumb.dir.length&&(a+=1,r!=this.thumb.dir[h].id);h++);var n=Math.floor(a/param.thumb.inRow),o=(i-e)/s,c=Math.floor(o*n);this.$set(this.thumb.scroll,"top",c)}}}},thumbShowMixin={methods:{thumbMarkSet:function(){this.$set(this.thumb,"mark",this.thumb.showed)},thumbMarkJumpTo:function(){if(!1!==this.thumb.mark){this.$set(this.thumb,"showed",this.thumb.mark);var e=this.getThumbById(this.thumb.mark);e&&(this.thumbJumpToIdFrameSet(e.id),this.thumbSelectById(e.id),this.sceneSet(e),this.console(e.name),this.size(e))}},thumbGoShow:function(e){var t,i,s,r,a=this.thumb.showed,e=e||"end";if(-1==["home","end","prev","next","prevRow","nextRow"].indexOf(e))return!1;if(!1!==(t=this.thumbGetIndex(a,e))){var h=this.thumb.cache.dir[t];h&&(s=this.thumbInFrame(t),s||(r=e,"prevRow"==e&&(r="prev"),"nextRow"==e&&(r="next"),i=this.thumbGetFirstIdInFrame(r),this.thumbFrameSet(i)),this.$set(this.thumb,"showed",h.id),this.sceneSet(h),this.console(h.name),this.size(h))}}}},treeMixin={methods:{treeInit:function(e){var e=e||__startDir,t=e.split(param.pathSeparator);t[0]="/";var i=[];t.forEach(function(e,s){var r;r=0==s?"/":path.normalize(t.slice(0,s+1).join(path.sep));var a=fs.readdirSync(r).filter(function(e){var t=!1;if(-1!=e.search(/\.zip$/))return!0;if(-1==e.search(/^\./)){if(fs.existsSync(path.join(r,e))){var i=fs.statSync(path.join(r,e))
;i&&(t=i.isDirectory())}return t}});a.length>0&&i.push(a)}),this.$set(this,"tree",this.treeBuilder(e,t,i))},treeBuilder:function(e,t,i){function s(){function e(e,t){return new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare(e.name,t.name)}for(var r,n,o=i[a],c=t[a],l=[],d=a,u=!1,m=!1,f=!1,p=0;p<o.length;p++)r=o[p],n=zz.id("tree"),u=!1,f=!1,".zip"==path.parse(r).ext&&(u="zip",m=!1,f=h.getFileSizeSync(path.normalize(path.sep+t.slice(0,d).join(path.sep)+path.sep+r)).sizeFormatted),c==r&&a<i.length-1?(++a,l.push({name:r,children:s(),openFolder:!0,id:n,isFolder:m,ext:u,size:f})):l.push({name:r,id:n,isFolder:m,ext:u,size:f}),param.tree.cachePaths[n]=path.normalize(path.sep+t.slice(0,d).join(path.sep)+path.sep+r);return l.sort(e),l}if(t&&t){var r,a=0,h=this;t.shift(),r={name:"/ [root]",children:s(),openFolder:!0,id:"treeRoot",isFolder:!0},param.tree.cachePaths.treeRoot="/";var n=param.tree.cachePaths,o=e||__startDir;__startPath&&-1!=__startPath.search(/\.zip$/)&&(o=__startPath);for(var c in n)if(n[c]==o){c,this.treeSelect(c);break}return param.startApp&&(param.startApp=!1,Vue.nextTick(function(){this.treeScrollSelectedIntoView()}.bind(this))),r}},treeScrollSelectedIntoView:function(){var e=document.querySelector("#"+this.treeParam.idEnd);e&&(e.scrollIntoView(),document.querySelector("#block-tree").scrollTop-=40)},treeBranch:function(e){if(e){var t=param.tree.cachePaths[e];"zip"==zz.getExtFromPath(t)&&(t=param.tmpDirs[t]);var i=fs.readdirSync(t).filter(function(e){var i=!1;if(".zip"==path.parse(e).ext)return i=!0;if(-1==e.search(/^\./)){if(fs.existsSync(path.join(t,e))){var s=fs.statSync(path.join(t,e));s&&(i=s.isDirectory())}return i}});if(!(i.length<1)){var s=[];return i.forEach(function(e){var i,r=zz.id("tree"),a=path.normalize(path.join(t,e)),h={name:e,id:r};".zip"==path.parse(e).ext&&(i="zip",h.ext=i,h.size=this.getFileSizeSync(a).sizeFormatted),param.tree.cachePaths[r]=a,s.push(h)}.bind(this)),s}}},treeBranchById:function(e){function t(i){var s;if(e==i.id)return i;if(i.children&&i.children.length>0)for(var r=0;r<i.children.length;r++)if(s=t(i.children[r]))return s;return!1}return t(this.tree)},treeParentBranchByIdChild:function(e){function t(s){if(e==s.id)return s;if(s.children&&s.children.length>0)for(var r=0;r<s.children.length;r++)t(s.children[r])&&(i={parent:s,index:r});return!1}var i={};return t(this.tree),i},treeSelect:function(e){this.treeParam.idEnd=e},treeRemoveBranch:function(e){var t=this.treeParentBranchByIdChild(e);t.parent.children.splice(t.index,1),param.removePathById(e)},treeAddChild:function(e){if(e){this.treeParentBranchByIdChild(this.treeParam.idEnd).parent.children&&(e.id="tree"+parseInt(this.tree.children[this.tree.children.length-1].id.replace(/tree/,""),10)+1)}},treeDirGo:function(e){var t,i,s,r=this.treeParam.idEnd,a=this.treeParentBranchByIdChild(r),h=a.parent.children,n=!1,o="zip"==a.parent.ext;o&&(r=a.parent.id,a=this.treeParentBranchByIdChild(r),h=a.parent.children);for(var c=0;c<h.length;c++)if(r==h[c].id){"next"==e?h[c+1]&&(n=h[c+1]):"prev"==e&&h[c-1]&&(n=h[c-1]);break}n&&(t=n.id,"zip"==n.ext&&(o=!0),"zip"==n.ext&&n.children&&(t=n.children.length>0?n.children[0].id:n.id),o?(i=zz.q("#"+t+' [data-act="clickUnzip"]'),console.log(t,i,"ee"),i||(s=param.tmpDirs[param.tree.cachePaths[t]],this.thumbLoad(s),i=zz.q("#"+t+' [data-act="clickDirName"]'))):i=zz.q("#"+t+' [data-act="clickDirName"]'),i&&i.click())},clickTreeFullpathJump:function(e){var t,i,s;if("path"==e.target.getAttribute("data-type")&&(t=e.target.getAttribute("data-path"),i=param.getIdByPath(t))){s=this.treeBranchById(i);for(var r=0;r<s.children.length;r++)s.children[r].children=[];this.treeSelect(i),this.$set(this,"fullpath",t),this.dirFullpathArr(t),Vue.nextTick(function(){this.treeScrollSelectedIntoView()}.bind(this))}},treeJumpToDir:function(e){param.tree.cachePaths={},param.startApp=!0,this.$set(this,"tree",{}),this.$set(this,"dir",e),this.dirFullpathArr(e),Vue.nextTick(function(){this.treeInit(e)}.bind(this)),this.thumbLoad(e),this.pathHistory.push(e)}}},zipMixin={methods:{unzipFile:function(e,t){var i,e=e||{},s="";if(e.id)s=param.tree.cachePaths[e.id];else if(!e.path)return;if(param.tmpDirs[s])return i=param.tmpDirs[s],void this.thumbLoad(i);i=this.makeTmpDir(s),this.$set(this.loading,"unzip",0),this.$set(this.loading,"unpackingId",param.getIdByPath(s)),this.$set(this.loading,"unpackingId",param.getIdByPath(s));var r=new DecompressZip(s);r.on("error",function(e){this.console(e)}.bind(this)),r.on("extract",function(e){this.$set(this.loading,"unzip",100),this.$set(this.loading,"unpackingId",-1);var s=!1,r=!1;fs.readdir(i,function(e,a){e||(a.forEach(function(e,t){var a=path.join(i,e);if(fs.lstatSync(a).isDirectory())return void(0==t&&(r=a));s=!0}),s?(this.thumbLoad(i),r=i):r||console.log(i,"err"),t&&t(s,r))}.bind(this))}.bind(this)),r.extract({path:i,filter:function(e){return"SymbolicLink"!==e.type}})},zipFolderById:function(e,t){var e=e||this.treeParam.idEnd,i=param.tree.cachePaths[e],s=i.match(/(.+)\/([^\/]+$)/);if(3==s.length){var r=s[2],a=r+".zip",h=s[1],n=path.join(h,a),o=this.tmpHaveDir(i);if(!0!==o){if(".zip"==path.parse(i).ext){var c=this.focus;return this.setFocus("no"),void zz.window.select_btn({btn:[{name:"close"},{name:"repack"}],title:lang.confirm.zip,des:lang.closeOrRepackQuestion},function(s){switch(this.setFocus(c),o=param.tmpDirs[i],s){case"close":this.deleteDirRecursive(o);var r,a=param.tmpDirs;for(var h in a)r=a[h],o==r&&delete a[h];this.console(", "+o+" removed ","append"),this.$set(this.thumb,"frame",[]),this.sceneSet("clear"),t&&t();break;default:fs.rename(i,i+".tmp",function(){var s=fs.createWriteStream(i),r=archiver("zip",{store:!0});s.on("close",function(){fs.unlink(i+".tmp",function(){this.console(", tmp middle removed ","append"),this.$root.deleteDirRecursive(o);var e,t=param.tmpDirs;for(var i in t)e=t[i],o==e&&delete t[i];this.console(", "+o+" removed ","append")}.bind(this));var s=zz.sizeFormat(r.pointer()),a=s.sizeFormated+" "+s.format;zz.window.alert({title:lang.archive.zipped,timer:2e3,des:i+"<br><b>"+a+"</b>"},void 0),this.console(a+", filepath: "+n),this.$set(this.thumb,"frame",[]),this.treeBranchById(e).size=a,this.sceneSet("clear"),t&&t()}.bind(this)),r.on("error",function(e){throw this.console("ERR: "+e),e}.bind(this)),r.pipe(s),r.directory(o,""),r.finalize()}.bind(this))}}.bind(this))}var l=lang.confirm.zip,d=i;zz.window.confirm({title:l,des:d},function(){var e=fs.createWriteStream(n),s=archiver("zip",{store:!0});e.on("close",function(){var e=zz.sizeFormat(s.pointer()),i=e.sizeFormated+" "+e.format;zz.window.alert({title:lang.archive.zipped,timer:5e3,des:"<b>"+a+"</b><br>"+i},void 0),this.console(i+", filepath: "+n),t&&t()}.bind(this)),s.on("error",function(e){throw this.console("ERR: "+e),e}.bind(this)),s.pipe(e),s.directory(i,r),s.finalize()}.bind(this))}}},zipFiles:function(){var e=this.thumb.selected;if(e&&!(e.length<1)){var t=this.treeParam.idEnd,i=param.tree.cachePaths[t],s=this.getThumbById(e[0]).name.replace(/\.[a-z0-9]+$/,""),r=s+".zip",a=i,h=path.join(a,r),n=lang.confirm.zip,o=h;zz.window.confirm({title:n,des:o},function(){var t,i=fs.createWriteStream(h),s=archiver("zip",{store:!0});i.on("close",function(){var e=zz.sizeFormat(s.pointer()),t=e.sizeFormated+" "+e.format;zz.window.alert({title:lang.archive.zipped,timer:5e3,des:r+"<br><b>"+t+"</b>"},void 0),this.console(t+", filepath: "+h),zz.q("#"+this.treeParam.idEnd+' [data-act="clickReloadDir"]').click()}.bind(this)),s.on("error",function(e){throw this.console("ERR: "+e),e}.bind(this)),s.pipe(i);for(var a=0;a<e.length;a++)t=this.getThumbById(e[a]),s.file(t.path,{name:t.name});s.finalize()}.bind(this))}},zipFilesWithParam:function(e,t){var i,s=e.filename||"name"+(new Date).getTime()+".zip",r=e.files||[],a=e.zipFolder||"";if(""!=a&&!(r.length<1)){var h=path.join(a,s),n=fs.createWriteStream(h),o=archiver("zip",{store:!0});n.on("close",function(){var e=zz.sizeFormat(o.pointer()),t=e.sizeFormated+" "+e.format;zz.window.alert({title:lang.archive.zipped,timer:5e3,des:s+"<br><b>"+t+"</b>"},void 0),this.console(t+", filepath: "+h)}.bind(this)),o.on("error",function(e){throw this.console("ERR: "+e),e}.bind(this)),o.pipe(n);for(var c=0;c<r.length;c++)i=r[c],o.file(i.path,{name:i.name});o.finalize()}},clickZip:function(){this.thumb.selected.length>0?this.zipFiles():this.zipFolderById()},clickZipCutOne:function(){var e=this.focus;this.clickFocus("none"),zz.window.file({title:lang.file.new,des:lang.file.new,filename:"name"},function(t){var i,s,r,a,h,n=[];i=param.tree.cachePaths[this.treeParam.idEnd],a=path.parse(i),".zip"==a.ext?h=a.dir:(s=param.getTmpDirFromPath(i),r=param.getOribinalPathByTmp(s),h=path.parse(r).dir),t+=".zip",this.thumb.selected.forEach(function(e){var t=this.getThumbById(e);n.push({path:t.path,name:t.name})}.bind(this)),this.zipFilesWithParam({filename:t,files:n,zipFolder:h},function(e){this.console("zip created")}),this.setFocus(e)}.bind(this))},clickZipFolders:function(e){var t=t||this.treeParam.idEnd,i=param.tree.cachePaths[t],e=e||{},s=[];this.getDirChildren(i,function(r){function a(){var n=r.shift();if(s.push(n),!n)return e.deleteFoldersAfterZip&&s.forEach(function(e){e&&h.deleteDirRecursive(e)}),zz.window.alert({title:lang.archive.zipped,timer:2e3,des:"<b>"+lang.archive.zipped+"</b><br>"},void 0),void zz.q("#"+t+' [data-act="clickReloadDir"]').click();var o=path.parse(n).base,c=o+".zip",l=path.join(i,c),d=fs.createWriteStream(l),u=archiver("zip",{store:!0});d.on("close",function(){var e=zz.sizeFormat(u.pointer()),t=e.sizeFormated+" "+e.format;h.console(t+", filepath: "+l),setTimeout(a,100)}.bind(h)),u.on("error",function(e){throw h.console("ERR: "+e),e}.bind(h)),u.pipe(d),u.directory(n,""),u.finalize()}var h=this;".zip"!=path.parse(i).ext&&a()}.bind(this))}}},videoMixin={methods:{clickVideo:function(e){if(!param.exec&&e){var t=zz.q("#block-video-scroll").offsetWidth;this.$set(this.video.scroll,"width",t);var i='ffmpeg -i "'+e+'" 2>&1 | grep "Duration"';require("child_process").exec(i,function(t,i,s){if(!t){var r,a,h,n,o=i.match(/Duration:\s?([0-9:.]+)/),c=0,l=0;o[1]&&(c=o[1],r=c.match(/[0-9]+/g),r.length>3&&(a=parseInt(r[0],10),h=parseInt(r[1],10),n=parseInt(r[2],10),parseInt(r[3],10),l=60*a*60+60*h+n)),this.$set(this.video,"duration",c),this.video.durationSec=l,this.videoStreamRun(e)}}.bind(this))}},videoStreamRun:function(e){if(this.$set(this.flag,"loadingVideoStream",!0),e){if(-1!=e.search(/"/))return console.log("error symbol: double quote"),void this.console("error symbol: double quote");var e=e,t=this.video.stream,i="http://"+t;this.video.streamHTTP=i;var s='vlc --intf dummy --live-caching=6000 "'+e+'" -vvv input_stream --sout "'+this.video.param+"dst="+t+'}"';param.exec=require("child_process").exec(s),this.video.streamStatus=!1,setTimeout(function(){this.video.el=this.videoGet(),setTimeout(this.videoGetStatus.bind(this),8e3),this.videoSecCounter()}.bind(this),1e3)}},videoLoadingStream:function(){this.video.el.currentTime>0?this.$set(this.flag,"loadingVideoStream",!1):setTimeout(this.videoLoadingStream.bind(this),400)},videoSecCounter:function(){var e=0;e=parseInt(this.video.el.currentTime,10),this.video.streamStartTime>0&&(e+=this.video.streamStartTime),this.$set(this.video,"sec",e),this.console("sec: "+e);var t=zz.remainder(e,60),i=t.int+": "+t.remainder;this.$set(this.video,"timeCurrent",i),setTimeout(this.videoSecCounter.bind(this),1e3)},videoNextSecond:function(e,t){var e=e||900;t||(e=this.video.sec+e),this.videoSecCounter(e),zz.q("#sceneVideo").pause(),this.videoStreamClear(),this.video.streamStartTime=e;var i=this.video.stream+"/time="+e,s="http://"+i;zz.q("#sceneVideo").src=s,this.video.streamHTTP=s;var r='vlc --intf dummy "'+this.scene.src+'" --start-time='+e+' -vvv --sout "'+this.video.param+"dst="+i+'}"';param.exec=require("child_process").exec(r),this.video.streamStatus=!1,setTimeout(this.videoGetStatus.bind(this),400)},videoGetStatus:function(){if(!0!==this.video.streamStatus){console.log("get status");var e=new XMLHttpRequest;e.open("GET",this.video.streamHTTP,!0),e.onprogress=function(){200==e.status?(this.videoGetStatusCheck(),this.video.streamStatus=!0,e.abort()):!1===this.video.streamStatus&&setTimeout(this.videoGetStatus.bind(this),400),e.abort()}.bind(this),e.send(null)}},videoGetStatusCheck:function(){this.videoGet().src=this.video.streamHTTP,this.videoGet().play().catch(function(e){setTimeout(function(){this.videoGet().play(),this.video.streamStatus=!1}.bind(this),1e3)}.bind(this))},videoStreamClear:function(){param.exec&&param.exec.pid&&(process.kill(param.exec.pid+1),param.exec=null)},videoParamReset:function(){this.$set(this.video,"sec",0),this.$set(this.video,"duration",0),this.$set(this.video,"durationSec",0),this.$set(this.video.scroll,"left",0)},videoNextSec:function(e){this.videoGet().currentTime+=e},videoPrevSec:function(e){this.videoGet().currentTime-=e},videoStartPause:function(){var e=this.videoGet();e.paused?e.play():e.pause()},videoFullscreen:function(){var e=this.videoGet();this.video.fullscreen?(e.webkitExitFullScreen(),this.$set(this.video,"fullscreen",!1)):(e.webkitRequestFullscreen(),this.$set(this.video,"fullscreen",!0))},videoExitFullscreen:function(){this.videoGet().webkitExitFullScreen(),this.$set(this.video,"fullscreen",!1)},isVideoSupported:function(e,t){var i=!1;return"video"==t&&(i=!0),i},isVideoUnsupported:function(e){var t=!1;return-1!=[].indexOf(e)&&(t=!0),t},videoStartPauseUnsuported:function(){var e=this.getThumb();console.log(e,"clc")},videoStreamStop:function(){console.log(param.exec.pid),process.kill(param.exec.pid+1)},videoScrollMouseMove:function(e){var t=this.video.scroll.left+e.left;t<0||t>this.video.scroll.width||(this.$set(this.video.scroll,"left",t),this.$set(this.video.scroll,"active",!0))}}},dragAndDropMixin={methods:{ddMouseInit:function(e,t){var i=t.data_dd;if(i)switch(i){case"thumb-scroll":this.$set(this.thumb.scroll,"active",!0);var s=this.thumb.thumbnails.height-this.thumb.scroll.height,r=Math.floor(s/this.thumb.rowsTotal);this.thumb.scroll.heightScrollOffsetRow=r;break;case"middle-vl":var a=zz.q("#block-middle-left");param.resizer.verticalLineInitX=e.clientX,param.resizer.ghostEl=zz.q("#middle-left-vl-ghost"),param.resizer.ghostEl.style.height=a.offsetHeight+"px",param.resizer.ghostEl.style.left=e.clientX+"px",param.resizer.ghostEl.style.display="";break;case"video-scroll":var h=zz.q("#block-video-scroll").offsetWidth||1e3;h-=10,this.$set(this.video.scroll,"active",!0),this.$set(this.video.scroll,"width",h)}},ddMouseMove:function(e,t){var i=t.data_dd;if(i)switch(i){case"sceneCanvas":var s={src:this.scene.src,width:this.scene.imgDrawnWidth,height:this.scene.imgDrawnHeight,left:this.scene.left,top:this.scene.top};s.left=this.scene.left+t.left,s.top=this.scene.top+t.top,this.sceneMoveDraw(s);break;case"thumb-scroll":this.thumbScrollMouseMove(t);break;case"middle-vl":this.ddMiddleVLMouseMove(e);break;case"video-scroll":this.videoScrollMouseMove(t)}},ddCallback:function(e,t){var i=e.target,s=i.getAttribute("data-dd");if("thumb-scroll"==t.data_dd&&(s="thumb-scroll"),"video-scroll"==t.data_dd&&(s="video-scroll"),"middle-vl"==t.data_dd&&(s="middle-vl"),s)switch(s){case"thumb-scroll":this.$set(this.thumb.scroll,"active",!1);break;case"middle-vl":var r=param.resizer.verticalLineInitX,a=e.clientX,h=r-a,n=zz.q("#block-middle-left");if(!n)return;var o=n.offsetWidth,c=o-h;n.style.width=c+"px",param.resizer.ghostEl.style.left=e.clientX+"px",param.resizer.ghostEl.style.display="none";var l=zz.q("#thumb"),o=l.offsetWidth,d=l.offsetHeight;param.thumb.blockWidth=o,param.thumb.inRow=Math.floor(o/param.thumb.width),param.thumb.rows=Math.floor(d/param.thumb.rowHeight);break;case"video-scroll":this.$set(this.video.scroll,"active",!1);var u=Math.floor(this.video.scroll.left*this.video.durationSec/this.video.scroll.width);this.videoNextSecond(u,"set");break;case"tree":var m=this.thumb.selected;if(m.length>0){var f=param.getPathById(i.getAttribute("data-id"));if(m.length<1)return;var p=lang.dd.files,b=lang.selected+":"+m.length;e.ctrlKey&&(p=lang.dd.filesCopy),zz.window.confirm({title:p,des:b},function(){var t=m.length,i=0;m.forEach(function(s){var r=this.getThumbById(s),a=r.path,h=path.join(f,r.name);e.ctrlKey?this.copyFile(a,h,function(e){if(e)throw e;++i>=t&&this.console("copied")}.bind(this)):fs.rename(a,h,function(e){if(e)throw e;if(this.deleteThumbById(s),++i>=t){this.deleteThumbEnd(i);var r=param.getPathById(this.treeParam.idEnd),a=r.split(path.sep);for(var h in param.tmpDirs)-1!=param.tmpDirs[h].search(a[2])&&(this.zipChanged[h]=!0);this.selectDir(this.fullpath)}}.bind(this))}.bind(this))}.bind(this))}}},ddMiddleVLMouseMove:function(e){param.resizer.ghostEl.style.left=e.clientX+"px";var t=zz.q("#thumb"),i=t.offsetWidth,s=t.offsetHeight;param.thumb.blockWidth=i,param.thumb.inRow=Math.floor(i/param.thumb.width),param.thumb.rows=Math.floor(s/param.thumb.rowHeight)}}},searchMixin={methods:{searchLineKeyUp:function(e){var t=e.target,i=t.value,s=this.fullpath,r="",a=path.parse(s);this.console("start search: "+i),this.$set(this.search,"val",i),-1!=a.dir.search(/\/media/)?(r=path.join(s,"searchDB.json"),fs.open(r,"r",function(t,a){if(t)"ENOENT"===t.code&&(this.console("createNewDB","append"),this.fileGetListByDir(s,function(e){var t=this.searchInList(i,e);this.searchSetList(t);var s=JSON.stringify(e);fs.writeFile(r,s,function(e){if(e)return console.log(e)}.bind(this))}.bind(this)));else if(e.ctrlKey){var h=fs.lstatSync(r);h.isFile()&&(fs.unlinkSync(r),this.searchFileDBCreate(s,r,i))}else this.console("in exist","append"),fs.readFile(r,function(e,t){e&&console.log(e);var s=JSON.parse(t),r=this.searchInList(i,s);this.searchSetList(r)}.bind(this))}.bind(this))):this.fileGetListByDir(s,function(e){var t=this.searchInList(i,e);this.searchSetList(t)}.bind(this))},searchFileDBCreate:function(e,t,i){this.console("createNewDB","append"),this.fileGetListByDir(e,function(e){var s=this.searchInList(i,e);this.searchSetList(s);var r=JSON.stringify(e);fs.writeFile(t,r,function(e){if(e)return console.log(e)}.bind(this))}.bind(this))},searchInList:function(e,t){for(var i,s,r=new RegExp(e,"i"),a={},h=0;h<t.length;h++)s=t[h],-1!=s.search(r)&&(i=path.parse(s).dir,a[i]?a[i].push(s):(a[i]=[],a[i].push(s)));return a},searchSetList:function(e){if(!e)return void console.log("need list Object");var t={};for(var i in e)t[i]={dir:i,file:e[i],total:e[i].length},e[i].length<3&&(t[i].showFiles=!0);this.$set(this.search,"list",t)},clickSearch:function(e){var t,i,s,r=e.target,a=r.getAttribute("data-act");switch(a){case"item":if(!(i=r.getAttribute("data-fullpath")))return;this.treeJumpToDir(i);break;case"group":i=r.getAttribute("data-fullpath"),1==this.search.list[i].showFiles?this.$set(this.search.list[i],"showFiles",!1):this.$set(this.search.list[i],"showFiles",!0);break;case"file":i=r.getAttribute("data-dir"),t=r.getAttribute("data-fullpath"),s=path.parse(t).base,this.treeJumpToDir(i),setTimeout(function(){console.log(s),this.thumbSelectBy("name",s)}.bind(this),2e3);break;case"turnOff":0==this.search.turnOff?this.$set(this.search,"turnOff",!0):this.$set(this.search,"turnOff",!1);break;case"close":this.$set(this.search,"list",{}),this.$set(this.search,"val","")}}}},stockMixin={methods:{stockCreateFolder:function(e){if(e){var t=this.thumb.selected;if(t.length<1)return void this.console("select files!");var i=new Date,s=("0"+(i.getMonth()+1)).slice(-2),r=("0"+i.getUTCDate()).slice(-2),a=i.getFullYear(),h=a+"_"+s+"_"+r,n=h+"_"+e,o=path.join(os.homedir(),"batches",n);fs.mkdirSync(o);var c=t.length,l=0;t.forEach(function(e){var t=this.getThumbById(e),i=t.path,s=path.join(o,t.name);fs.rename(i,s,function(t){if(t)throw t;this.deleteThumbById(e),++l>=c&&this.deleteThumbEnd(l)}.bind(this))}.bind(this))}},stockEps10:function(e){function t(e){return iconv.encode(e,"win1255").toString("utf8")}function i(e,t){-1==t.search(/Creator\:\sAdobe\sIllustrator\(R\)\s10\.0/)&&r.push(e),-1==t.search(/[a-zA-Z0-9_\-.,]+/gim)&&h.push(e),-1!=t.search(/filePath/)&&n.push(e),-1!=t.search(/BeginBinary/)&&a.push(e)}function s(e){return path.parse(e).base}var r=[],a=[],h=[],n=[],o=!1;!function(e,s){"/"!=e[e.length-1]&&(e=e.concat("/"));var r=r||require("fs");r.readdirSync(e).forEach(function(s){if(-1!=s.search(/\.eps$/)){var a=e+s;i(a,t(r.readFileSync(a)))}-1!=s.search(/\.txt$/)&&(o=!0)})}(e);var c=[];a.length>0&&(c.push("<b>exists binari Objects: </b>"),c.push("<br>"),a.forEach(function(e){c.push(s(e)+"<br>")})),r.length>0&&(c.push("<br>"),c.push('<b style="color:red">--------------- ATTENTION! --------------- EPS 10 not found: </b>'),c.push("<br>"),r.forEach(function(e){c.push(s(e)+"<br>")})),h.length>0&&(c.push("<br>"),c.push("Bad name (cyrillic character): "),c.push("<br>"),h.forEach(function(e){c.push(s(e)+"<br>")})),n.length>0&&(c.push("<br>"),c.push('<b style="color:red">--------------- ATTENTION! --------------- Link exist: </b>'),c.push("<br>"),n.forEach(function(e){c.push(s(e)+"<br>")})),c.length<1&&c.push("ok!");var l=c.join("");zz.window.alert({title:"Ready for stock",des:l,classWindow:"zz-window__alert-ready-for-stock"},function(){}),o||function(){var e,t=app.treeParam.idEnd,i=param.tree.cachePaths[t];e=path.join(i,"stock.txt");var s=s||require("fs");s.closeSync(s.openSync(e,"w"))}()}}},param={programName:"tophat",bookmarksFileName:"tophat_bookmarks.json",tmpDirs:{},startApp:!0,thumb:{blockHeight:511,blockWidth:650,width:122,height:142,inRow:4,rows:4,rowHeight:162.5},resizer:{verticalLineInitX:0,ghostEl:null},video:{sec:0},exec:null,tree:{cachePaths:{}},pathSeparator:"/",keyDown:null,keyUp:null,key:{arrowRight:39,arrowLeft:37,arrowTop:38,arrowBottom:40,end:35,home:36,delete:46,space:32,apostrophe:192,esc:27,equal:187,minus:189,pageUp:33,pageDown:34,enter:13,f11:122,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,13:"enter",27:"esc",32:"space",33:"pageUp",34:"pageDown",35:"end",36:"home",37:"arrowLeft",38:"arrowTop",39:"arrowRight",40:"arrowBottom",46:"delete",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",122:"f11",187:"equal",189:"minus",192:"apostrophe"},getIdByPath:function(e){var t=param.tree.cachePaths;for(var i in t)if(e==t[i])return i},getPathById:function(e){return!!e&&(!!param.tree.cachePaths[e]&&param.tree.cachePaths[e])},getOribinalPathByTmp:function(e){var t;for(var i in param.tmpDirs)if(t=param.tmpDirs[i],e==t)return i},removePathById:function(e){delete param.tree.cachePaths[e]},encUrl:function(e){return encodeURI(e).replace(/#/gim,"%23")},getTmpDirFromPath:function(e){var t=e.split(path.sep);return"/"+path.join(t[1],t[2])}};param.keyCommandsCache={all:{},thumb:{},dir:{},scene:{}},param.keyCommands=[{name:"closeProgramm",keyStr:"ctrl+q"},{name:"saveFile",keyStr:"ctrl+s",focus:["scene"]},{name:"dirRename",keyStr:"shift+r",focus:["dir"]},{name:"zip",keyStr:"shift+z",focus:["thumb","dir"]},{name:"thumbMarkSet",keyStr:"t",focus:["thumb"]},{name:"thumbMarkJumpTo",keyStr:"ctrl+t",focus:["thumb"]},{name:"thumbSelectAll",keyStr:"ctrl+a",focus:["thumb"]},{name:"thumbUnselectAll",keyStr:"ctrl+shift+a",focus:["thumb"]},{name:"thumbNextRow",keyStr:"c",focus:["thumb"]},{name:"thumbPrevRow",keyStr:"d",focus:["thumb"]},{name:"thumbNextShow",keyStr:"arrowRight",focus:["thumb"]},{name:"thumbPrevShow",keyStr:"arrowLeft",focus:["thumb"]},{name:"endShow",keyStr:"end",focus:["thumb"]},{name:"homeShow",keyStr:"home",focus:["thumb"]},{name:"nextSelect",keyStr:"b",focus:["thumb"]},{name:"prevSelect",keyStr:"v",focus:["thumb"]},{name:"prevRowSelect",keyStr:"s",focus:["thumb"]},{name:"nextRowSelect",keyStr:"g",focus:["thumb"]},{name:"delete",keyStr:"delete",focus:["thumb"]},{name:"prevDir",keyStr:"ctrl+arrowLeft",focus:["thumb"]},{name:"nextDir",keyStr:"ctrl+arrowRight",focus:["thumb"]},{name:"prevDir",keyStr:"pageUp",focus:["thumb"]},{name:"nextDir",keyStr:"pageDown",focus:["thumb"]},{name:"repackArch",keyStr:"ctrl+r",focus:["thumb"]},{name:"thumbImgFullscreen",keyStr:"f",focus:["thumb"]},{name:"sceneImgZoomPlus",keyStr:"equal",focus:["scene"]},{name:"sceneImgZoomMinus",keyStr:"minus",focus:["scene"]},{name:"sceneMove",keyStr:"arrowLeft",focus:["scene"]},{name:"sceneMoveRight",keyStr:"arrowRight",focus:["scene"]},{name:"sceneMoveTop",keyStr:"arrowTop",focus:["scene"]},{name:"sceneMoveBottom",keyStr:"arrowBottom",focus:["scene"]},{name:"deleteDir",keyStr:"ctrl+delete",focus:["dir"]},{name:"videoNextSec",keyStr:"b",focus:["scene"],type:"video"},{name:"videoPrevSec",keyStr:"v",focus:["scene"],type:"video"},{name:"videoNextSec10",keyStr:"arrowRight",focus:["scene"],type:"video"},{name:"videoPrevSec10",keyStr:"arrowLeft",focus:["scene"],type:"video"},{name:"videoNextSec30",keyStr:"g",focus:["scene"],type:"video"},{name:"videoNextSec30arrowTop",keyStr:"arrowTop",focus:["scene"],type:"video"},{name:"videoPrevSec30",keyStr:"arrowBottom",focus:["scene"],type:"video"},{name:"videoStartPause",keyStr:"space",focus:["scene"],type:"video"},{name:"videoStartPause2",keyStr:"apostrophe",focus:["scene"],type:"video"},{name:"videoFullscreen",keyStr:"f",focus:["scene"],type:"video"},{name:"videoExitFullscreen",keyStr:"esc",focus:["scene"],type:"video"},{name:"textSelect",keyStr:"a",focus:["scene"],type:"txt"},{name:"fullscreenWindow",keyStr:"f11"}],Vue.component("tree",{template:"#tree-item-template",props:{tree:Object},data:function(){return{open:!1,packStage:1}},computed:{isFolder:function(){var e=!1;return this.tree.children&&this.tree.children.length&&(e=!0),e},isSelected:function(){var e=!1;return this.tree.id==this.$root.treeParam.idEnd&&(e=!0),e},isGif:function(){return"gif"==this.tree.ext},isZip:function(){return"zip"==this.tree.ext},isZipOpen:function(){return 2==this.packStage&&"zip"==this.tree.ext},isZipPacked:function(){return 3==this.packStage&&"zip"==this.tree.ext},isZipDefault:function(){return 1==this.packStage&&"zip"==this.tree.ext},isSvg:function(){return"svg"==this.tree.ext},isUnpacking:function(){return this.tree.id==this.$root.loading.unpackingId},openFolder:function(){return"treeRoot"==this.tree.id?(this.tree.openFolder=!0,!0):this.tree.openFolder?(this.tree.openFolder=!1,this.open?(this.open=!1,this.open):(this.open=!0,this.open)):this.open}},methods:{clickZipRepack:function(){this.$root.zipFolderById(this.tree.id,function(){this.$set(this,"open",!1),this.$set(this,"packStage",3),this.treeRemoveChildren(),setTimeout(function(){this.$set(this,"packStage",1)}.bind(this),1e3)}.bind(this))},clickZipUnpack:function(){var e=this.tree.id;this.$root.unzipFile({id:e},function(t,i){this.$root.treeSelect(e),this.packStage=2,this.open=!0;var s=setInterval(function(){function r(){if(!(h>1e3)){if(h+=1,zz.q("#"+param.getIdByPath(i)))return h=0,void zz.q("#"+param.getIdByPath(i)+' [data-act="clickDirName"]').click();setTimeout(r.bind(this),300)}}if(this.$root.loading.unzip>=100){clearInterval(s);var a=this.$root.treeBranch(e);if(this.treeAddChildren(a),!t){var h=0;setTimeout(r.bind(this),100)}}}.bind(this),200)}.bind(this))},clickDirName:function(){function e(e,t){return new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"}).compare(e.name,t.name)}0==this.open&&(this.open=!0);var t,i=this.tree.id,s=param.tree.cachePaths[i],r=!0;if(this.$root.treeSelect(i),this.$root.selectDir(s),this.$root.setFocus("thumb"),void 0==this.tree.children?r=!1:zz.has(this.tree.children,"length")&&0==this.tree.children.length&&(r=!1),!r){if("zip"==zz.getExtFromPath(s))return void(this.open=!1);(t=this.$root.treeBranch(i))&&(t.sort(e),this.treeAddChildren(t))}Vue.nextTick(function(){this.$root.treeScrollSelectedIntoView()}.bind(this))},clickIcoDir:function(){0==this.open?this.clickDirName():this.open=!1},clickReloadDir:function(){this.open=!1,this.treeRemoveChildren(),this.clickDirName()},treeAddChildren:function(e){if(Vue.set(this.tree,"children",[]),e&&e.length>0){for(var t=0;t<e.length;t++)this.tree.children.push(e[t]);this.open=!0}},treeRemoveChild:function(e){var t=-1,e=e||this.$root.treeParam.idEnd;if(e){for(var i=0;i<this.tree.children.length;i++)if(e==this.tree.children[i].id){t=i;break}this.$parent.tree.children.splice(t,1)}},treeRemoveChildren:function(){delete this.tree.children}}});var lang={en:{confirm:{delete:"Delete? ",deleteEnd:" items.",deleteFolder:"Are you sure, than do you want delete dir? ",deleteFoldersAfterZip:"Delete dir after arch?",wasDeleted:" dir or file deleted",zip:"Arch? ",zipChildrenFolders:"Arch dirs? ",rezip:"Arch changed zip file? "},archive:{zipped:"Archive created",cutOne:"Create separate archive",folders:"Create archives from subdirs",unpackBeforeZip:"Unpack zip file, before zip"},pack:"Pack",packed:"Packed",unpack:"Unpack",closeOrRepackQuestion:"Close or repack?",from:"from",delete:"Delete",deleted:"deleted: ",deleteEnd:"deleted",move:"Moving",file:{file:"file",files:"files",create:"Create file",new:"New file",save:"Save",saved:"File saved.",confirm:{save:"Save file?"}},dir:{create:"Create dir",new:"New dir",name:"Dir Name"},bookmarks:{saved:"Bookmarks saved",add:"Add bookmark",delete:"Delete bookmark",show:"Show/hide bookmarks",title:"Bookmarks"},antiAliasing:"Turn On|Turn Off antialiasing",history:{back:"History - backward",forward:"History - forward"},rename:"Rename",renameGroup:"Rename group",epsStock:"Check EPS for Stock",epsStockCreateDir:"Create dir inside [user/batches] from selected EPS+JPG for Stock",total:"total: ",renamed:"renamed: ",renameFinish:"All files renamed!",rotate:"Rotate",dd:{files:"Move files?",filesCopy:"Copy files?"},video:{createStream:"Create stream"},alert:{selectFiles:"Need select files"},search:{line:"Search by Ctrl+Enter"},selected:"selected",sort:{by:{date:"by date",name:"by name"}},arrow:{up:"↑",down:"↓",right:"→",left:"←"},treeTab:{bookmarks:"Bookmarks",tree:"Folders"},close:"Close"},ru:{confirm:{delete:"Удалить? ",deleteEnd:" шт.",deleteFolder:"Вы уверены, что хотите удалить папку? ",deleteFoldersAfterZip:"Удалить папки после архивации?",wasDeleted:" папка или файлы удалены",zip:"Архивировать? ",zipChildrenFolders:"Архивировать папки? ",rezip:"Архивировать измененный zip файл? "},archive:{zipped:"Архив создан",cutOne:"Создать отдельный архив",folders:"Создать архивы из подпапок",unpackBeforeZip:"Распакуйте zip файл, перед обработкой"},pack:"Упаковать",packed:"Упакован",unpack:"Распаковать",closeOrRepackQuestion:"Закрыть или упаковать?",from:"из",delete:"Удалить",deleted:"удалено: ",deleteEnd:"удаление завершено",move:"Перемещение",file:{file:"файл",files:"файлы",create:"Создать файл",new:"Новый файл",save:"Сохранить",saved:"Файл сохранен.",confirm:{save:"Сохранить файл?"}},dir:{create:"Создать папку",new:"Новая папка",name:"Название папки"},bookmarks:{saved:"Закладки сохранены",add:"Добавить закладку",delete:"Удалить закладку",show:"Показать/скрыть закладки",title:"Закладки"},antiAliasing:"Включить|Выключить черезстрочность",history:{back:"История - назад",forward:"История - вперед"},rename:"Переименовать",renameGroup:"Переименовать группу",epsStock:"Проверить EPS для Stock",epsStockCreateDir:"Создать папку внутри [user/batches] из выделенных EPS+JPG for Stock",total:"всего: ",renamed:"переименовано: ",renameFinish:"Все файлы переименованы!",rotate:"Повернуть",dd:{files:"Переместить файлы?",filesCopy:"Копировать файлы?"},video:{createStream:"Создать поток"},alert:{selectFiles:"Нужно выделить файлы"},search:{line:"Поиск Ctrl+Enter"},selected:"выделено",sort:{by:{date:"по дате",name:"по имени"}},arrow:{up:"↑",down:"↓",right:"→",left:"←"},treeTab:{bookmarks:"Закладки",tree:"Дерево каталогов"},close:"Закрыть"}};const fs=require("fs"),os=require("os"),crypto=require("crypto"),path=require("path"),archiver=require("archiver"),iconv=require("iconv-lite"),exec=require("child_process").exec,DecompressZip=require("decompress-zip");var gui=require("nw.gui"),win=gui.Window.get(),argv=gui.App.argv,__startImg=!1,__startDir=!1,__startPath=!1;if(argv.length>0){__startPath=argv[0];var __startPathMatch=__startPath.match(/[^\/]+$/)
;__startPathMatch.length>0&&(__startImg=__startPathMatch[0]),__startDir=__startPath.replace(/[^\/]+$/,"").replace(/\/$/,"")}__startDir||(__startDir=process.cwd()),win.maximize();var lang=lang.en,ennoble=function(e){JSON.parse(JSON.stringify(e))},ennobleConsole=function(e){console.log(JSON.parse(JSON.stringify(e)))},app=new Vue({mixins:[thumbMixin,sceneMixin,searchMixin,treeMixin,zipMixin,dirMixin,fileMixin,deleteMixin,keyMixin,libMixin,thumbShowMixin,thumbScrollMixin,dragAndDropMixin,topMixin,bookmarksMixin,stockMixin,videoMixin],el:"#app",data:{tree:{},treeParam:{idEnd:0},bookmarks:[],treeTabSelected:"tree",search:{list:{},val:"",turnOff:!1},file:{autoUnzipLimit:300},fullpath:"/",fullpathArr:[],pathHistory:[],imgCachePreview:{},thumb:{cache:{dir:[],idRow:null,rows:[]},dir:[],frame:[],imgCache:{},width:106,height:80,heightFullLength:142,mark:!1,selected:[],showed:0,type:"img",threadsLoadingDir:[],thumbnails:{el:null,height:0},rowsTotal:0,scroll:{topInit:2,bottomInit:2,top:2,bottom:2,height:200,active:!1,heightScrollOffsetRow:0},sort:{name:{to:"increase",arrow:lang.arrow.down},date:{to:"decrease",arrow:""}}},flag:{show:{dirFullpath:!1},loading:!1,loadingVideoStream:!1},fullscreen:!1,zipChanged:{},video:{el:null,duration:0,durationSec:0,sec:0,timeCurrent:0,fullscreen:!1,scroll:{width:0,active:!1,left:0},param:"#transcode{vcodec=theo,acodec=vorb,channels=2}:standard{access=http,mux=ogg,",stream:"127.0.0.1:1234/video",streamHTTP:"http://127.0.0.1:1234",streamStartTime:0,streamStatus:!1},focus:"thumb",flagConfirm:{delete:!1},scene:{width:800,height:800,src:"",antiAliasing:!1,imgOriginalWidth:0,imgOriginalHeight:0,left:0,top:0,imgDrawnWidth:0,imgDrawnHeight:0,percentCurrent:100,offset:{left:0,top:0}},loading:{unzip:0,unpackingId:-1,percent:0,thumb:{total:0,loaded:0,scrollHeight:0,scrollTop:0,scrollTopCache:0,elDOM:null}}},computed:{selected:function(){var e=this.thumb.selected,t=this.thumb.showed;return e.indexOf(t)>-1},numThumb:function(){for(var e=1,t=0;t<this.thumb.dir.length&&this.thumb.showed!=this.thumb.dir[t].id;t++)e++;return e},isAntiAliasing:function(){return this.scene.antiAliasing},isFullscreen:function(){return this.fullscreen}},methods:{init:function(e){this.setFocus(this.focus);var t=e||__startDir;this.$set(this,"fullpath",t),this.dirFullpathArr(t),this.pathHistory.push(t),param.startApp&&this.treeInit(),this.thumbLoad(t),setTimeout(function(){if(this.loading.thumb.elDOM=zz.q(".thumbnails"),__startPath&&"zip"==zz.getExtFromPath(__startPath)){var e=this.getFileSizeSync(__startPath),t=param.getIdByPath(__startPath);if(e.sizeOriginal<1e6*this.file.autoUnzipLimit){var i=zz.q("#"+t+' [data-act="clickUnzip"]');i&&i.click()}else zz.q("#"+t+' [data-act="clickDirName"]').click()}}.bind(this),1e3),this.bookmarksRead()},closeProgramm:function(){var e,t=param.tmpDirs;for(var i in t)e=t[i],this.deleteDirRecursive(e);param.exec&&param.exec.pid&&process.kill(param.exec.pid+1),win.close(!0)},loadingStart:function(){this.$set(this.flag,"loading",!0)},loadingEnd:function(){this.$set(this.flag,"loading",!1)},wheel:function(e){var t=e.deltaY;t&&(e.ctrlKey?-1!=["jpg","jpeg","png","gif","eps","ai","svg"].indexOf(this.scene.ext)&&(t>0?this.sceneImgZoom("plus"):this.sceneImgZoom("minus")):t>0?(this.thumbGoShow("next"),this.thumbScrollMoveByKey()):(this.thumbGoShow("prev"),this.thumbScrollMoveByKey()))},clickFocus:function(e){e&&this.$set(this,"focus",e)},setFocus:function(e){if(e&&(this.$set(this,"focus",e),"no"!=e)){var t;switch(e){case"thumb":t=zz.q("#"+e),t&&t.focus();default:t=zz.q("#block-"+e),t&&t.focus()}}},setSizeImgToScene:function(e){var t=" "+e.width+"x"+e.height;this.scene.imgOriginalWidth=e.width,this.scene.imgOriginalHeight=e.height,this.scene.left=e.left,this.scene.top=e.top,this.scene.imgDrawnWidth=e.imgDrawnWidth,this.scene.imgDrawnHeight=e.imgDrawnHeight,this.scene.offset.left=0,this.scene.offset.top=0,this.console(t,"append")}},mounted:function(){this.init(__startDir),this.keyCommandsSetCache(),setTimeout(function(){var e,t=zz.q("#thumb");this.thumb.dir.length>0&&(e=__startImg?this.thumbSelectBy("name",__startImg):this.thumbSelectById(this.thumbGetIndex("first")))&&(0==this.thumb.selected.length&&this.sceneSet(e),this.console(e.name),this.size(e)),this.thumb.thumbnails.el=t,this.thumb.thumbnails.height=t.offsetHeight,t.focus(),document.body.addEventListener("keydown",this.keyDown,!1),zz.q("#thumb").addEventListener("wheel",this.wheel,!1),zz.q("#block-scene").addEventListener("wheel",this.wheel,!1),window.addEventListener("resize",this.resizeWin,!0),win.on("close",this.closeProgramm,!0),document.ondragstart=function(){return!1},document.body.onselectstart=function(){return!1};var i=zz.q("#start");i.parentNode.removeChild(i),zz.dd.init({sel:"#block-middle-left",title:"move",titleCtrl:"copy",callback:this.ddCallback,boxDataDD:["tree","thumb"]}),zz.dd.init({sel:"#app",mouseInit:this.ddMouseInit,mouseMove:this.ddMouseMove,callback:this.ddCallback})}.bind(this),1e3)}});